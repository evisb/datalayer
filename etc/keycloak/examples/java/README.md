[![Datalayer](https://docs.datalayer.io/logo/datalayer-25.svg)](https://datalayer.io)

# Keycloak with LDAP, Java and Swagger

> https://github.com/ivangfr/springboot-keycloak-openldap

For LDAP, see also [Blog about LDAP](https://blog.exceptionerror.io/2018/08/29/openldap-keycloak-and-docker).

```bash
cd $DLAHOME/lab/apps/keycloak/java/repo && \
  docker-compose up -d && \
  docker-compose ps
```

```bash
# Browse and login to phpLDAPadmin
open https://localhost:6443 # cn=admin,dc=datalayer,dc=io / admin
```

```bash
./import-openldap-users.sh # or use the https://localhost:6443 UI to import ./ldap/ldap-mycompany-com.ldif
ldapsearch -x -D "cn=admin,dc=datalayer,dc=io" \
  -w admin -H ldap://localhost:389 \
  -b "ou=users,dc=datalayer,dc=io" \
  -s sub "(uid=*)"
```

```bash
# Browse and login to Keycloak.
open http://localhost:8080 # admin / admin
```

Create a new Realm.

+ Go to top-left corner and hover the mouse over Master realm. A blue button Add realm will appear. Click on it.
+ On Name field, write `company-services`. Click on Create.

Create a new Client.

+ Click on Clients menu on the left.
+ Click Create button.
+ On Client ID field type `simple-service`.
+ Click on Save.
+ On Settings tab, set the Access Type to `confidential`.
+ Still on Settings tab, set the Valid Redirect URIs to `http://localhost:8080/*`.
+ Click on Save.

Go to Credentials tab.

+ Copy the value on Secret field. It will be used on the next steps.

Go to Roles tab.

+ Click Add Role button.
+ On Role Name type `user`.
+ Click on Save.

Integrate LDAP.

+ Click on the User Federation menu on the left.
+ Select ldap.
+ On Vendor field select `Other`.
+ On Connection URL type `ldap://<ldap-host OR machine-ip-address>` -  machine-ip-address can be obtained running the following command on a terminal `docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' ldap-host`
+ On Users DN type `ou=users,dc=datalayer,dc=io`.
+ On Bind DN type `cn=admin,dc=datalayer,dc=io`.
+ On Bind Credential set `admin`.
+ On Custom User LDAP Filter set `(gidnumber=500)` to just get developers.
+ Click on Save.

Click on Synchronize all users.

Configure users imported

+ Click on Users menu on the left.
+ Click on View all users. 3 users will be shown.
+ Edit user bgates.
 + Go to Role Mappings tab.
 + Select `simple-service` on the combo-box Client Roles.
 + Add the role user to bgates.
+ Do the same for the user sjobs.
+ Let's leave mcuban without user role.

```bash
./mvnw clean spring-boot:run
curl -i http://localhost:8080/api/public  # HTTP/1.1 200
curl -i http://localhost:8080/api/private # HTTP/1.1 302
```

Here, the application is trying to redirect the request to an authentication link.

Export to `SIMPLE_SERVICE_CLIENT_SECRET` environment variable the Client Secret generated by Keycloak for simple-service (Configuring Keycloak, step 4).

```bash
export SIMPLE_SERVICE_CLIENT_SECRET=$DLA_KEYCLOAK_REALM_CLIENT_SECRET
```

```bash
# Run the command below to get an access token for bgates user.
BGATES_ACCESS_TOKEN=$(curl -s -X POST \
  "http://localhost:8080/auth/realms/company-services/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=bgates" \
  -d "password=123" \
  -d "grant_type=password" \
  -d "client_secret=$SIMPLE_SERVICE_CLIENT_SECRET" \
  -d "client_id=simple-service" | jq -r .access_token)
echo $BGATES_ACCESS_TOKEN
# Call the endpoint GET /api/private using the cURL command below.
curl -i -H "Authorization: Bearer $BGATES_ACCESS_TOKEN" http://localhost:8080/api/private
```

It will return:

```
HTTP/1.1 200
...
bgates, it is private.
```

```bash
# Run the command below to get an access token for mcuban user.
MCUBAN_ACCESS_TOKEN=$(curl -s -X POST \
  "http://localhost:8080/auth/realms/company-services/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=mcuban" \
  -d "password=123" \
  -d "grant_type=password" \
  -d "client_secret=$SIMPLE_SERVICE_CLIENT_SECRET" \
  -d "client_id=simple-service" | jq -r .access_token )
# Try to call the endpoint GET /api/private using the cURL command below.
curl -i -H "Authorization: Bearer $MCUBAN_ACCESS_TOKEN" http://localhost:8080/api/private
```

As mcuban doesn't have the user role, he cannot access this endpoint. The endpoint return will be:

```
HTTP/1.1 403
...
{
  "timestamp":"2018-12-26T13:14:10.493+0000",
  "status":403,
  "error":"Forbidden",
  "message":"Forbidden",
  "path":"/api/private"
}
```

```bash
# Go to Keycloak and add the role user to the mcuban user.
open http://localhost:8080 # admin / admin
# Run the command on step 7) again to get a new access token for mcuban user.
# Call again the endpoint GET /api/private using the cURL command presented on step 8. 
MCUBAN_ACCESS_TOKEN=$(curl -s -X POST \
  "http://localhost:8080/auth/realms/company-services/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=mcuban" \
  -d "password=123" \
  -d "grant_type=password" \
  -d "client_secret=$SIMPLE_SERVICE_CLIENT_SECRET" \
  -d "client_id=simple-service" | jq -r .access_token )
# Try to call the endpoint GET /api/private using the cURL command below.
curl -i -H "Authorization: Bearer $MCUBAN_ACCESS_TOKEN" http://localhost:8080/api/private
```

It will return:

```
HTTP/1.1 200
...
mcuban, it is private.
```

The access token default `expiration period` is 5 minutes. Wait for this time and, using the same access token, try to call the private endpoint. It will return:

```
HTTP/1.1 401
...
WWW-Authenticate: Bearer realm="company-services", error="invalid_token", error_description="Token is not active"
```

Using `client_id` and `client_secret` to get access token.: You can get an access token to simple-service using `client_id` and `client_secret`.

```bash
# Go to Keycloak.
open http://localhost:8080 # admin / admin
```

Select company-services realm (if it is not already selected).

+ Click on Clients on the left menu.
+ Select `simple-service` client.
+ On Settings tab, turn ON the field Service Accounts Enabled.
+ Click on Save.

On Service Account Roles tab.

+ Select `simple-service` on the combo-box Client Roles.
+ Add the role user.

```bash
# Go to a terminal and run the commands
CLIENT_ACCESS_TOKEN=$(curl -s -X POST \
  "http://localhost:8080/auth/realms/company-services/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=client_credentials" \
  -d "client_secret=$SIMPLE_SERVICE_CLIENT_SECRET" \
  -d "client_id=simple-service" | jq -r .access_token)
# Try to call the endpoint GET /api/private using the cURL command below.
curl -i http://localhost:8080/api/private -H "authorization: Bearer $CLIENT_ACCESS_TOKEN"
```

It will return:

```
HTTP/1.1 200
...
service-account-simple-service, it is private.
```

```bash
# For `swagger`.
open http://localhost:8080/swagger-ui.html
```

Click on public-private-controller.

Click on `GET /api/public` to open it.

Then, click on Try it out button and, finally, click on Execute button 

It will return:

```
Code: 200
...
Response Body: It is public.
```

Now click on `GET /api/private`, it is a secured endpoint. Let's try it without authentication.

Click on Try it out button and then on Execute button It will return:

```
TypeError: Failed to fetch
```

In order to access the private endpoint, you need an access token. To get it, run the following commands in a terminal.

```bash
BGATES_ACCESS_TOKEN="Bearer $(curl -s -X POST \
  "http://localhost:8080/auth/realms/company-services/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=bgates" \
  -d "password=123" \
  -d "grant_type=password" \
  -d "client_secret=$SIMPLE_SERVICE_CLIENT_SECRET" \
  -d "client_id=simple-service" | jq -r .access_token)"
echo $BGATES_ACCESS_TOKEN
```

Copy (Ctr-C) the token generated (something like that starts with `Bearer ...`) and go back to Swagger.

Click on the Authorize button, paste (Ctr-V) the copied access token in the value field. Then, click on Authorize and, to finalize, click on Close.

Go to `GET /api/private`, click on Try it out and then on Execute button It will return:

```
Code: 200
...
Response Body: bgates, it is private.
```

Add a new user in LDAP.

```bash
cd $DLAHOME/lab/apps/keycloak/java && \
  ldapadd -H ldap://localhost -c -D "cn=admin,dc=datalayer,dc=io" -w admin -f ./user.ldif
ldapsearch -x -D "cn=admin,dc=datalayer,dc=io" \
  -w admin -H ldap://localhost:389 \
  -b "cn=Eric Charles,ou=users,dc=datalayer,dc=io" \
  -s sub "(uid=*)"
```

```bash
ECHARLES_ACCESS_TOKEN=$(curl -s -X POST \
  "http://localhost:8080/auth/realms/company-services/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=echarles" \
  -d "password=123" \
  -d "grant_type=password" \
  -d "client_secret=$SIMPLE_SERVICE_CLIENT_SECRET" \
  -d "client_id=simple-service" | jq -r .access_token)
echo $ECHARLES_ACCESS_TOKEN
# Call the endpoint GET /api/private using the cURL command below.
curl -i -H "Authorization: Bearer $ECHARLES_ACCESS_TOKEN" http://localhost:8080/api/private
```

```bash
# Shutdown the services.
docker-compose down -v
```

That'all Folks.
